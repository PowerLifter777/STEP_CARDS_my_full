(()=>{"use strict";const e={data:[],getCardById(e){const[t]=this.data.filter((t=>t.id===e));return t},delCardById(e){this.data=this.data.filter((t=>t.id!==e))}},t=async()=>{const e=await fetch("https://ajax.test-danit.com/api/v2/cards",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${JSON.parse(sessionStorage.token)}`}});return 200===e.status?e.json():void alert("Не удалось загрузить карточки. Сервер не доступен")};class s{constructor(e=document.body){this.wrapper=e}showLoginForm(){this.wrapper.classList.remove("modal--hide"),this.wrapper.innerHTML="";const e=document.createElement("div");e.classList.add("modal__content-wrapper","modal__content-wrapper--login"),this.wrapper.append(e),e.innerHTML='\n            <span class="modal-close">×</span>\n            <div class="modal__content">\n                <h3 class="modal__content-title">Welcome Back</h3>\n                <div class="modal__content-img">\n                    <picture>\n                        <source srcset="./dist/assets/images/log-icon.webp" type="image/webp">\n                            <img class="modal__content-icon" src="./dist/assets/images/log-icon.png" alt="login">\n                    </picture>\n                </div>\n                <form class="form-login">\n                    <input class="form-login__input" type="text" name="username" placeholder="email">\n                    <input class="form-login__input" type="password" id="password" name="password" placeholder="password">\n                    <button class="btn btn--small" type="submit">login</button>\n                </form>\n            </div>\n        ',this.closeModal("login")}closeModal(e){const t=this.wrapper.querySelector(".modal-close"),s=this.wrapper.querySelector('button[type="submit"]'),i=this.wrapper.querySelector(".modal__content-wrapper"),a=()=>{i.remove(),this.wrapper.classList.add("modal--hide")};"login"===e&&t.addEventListener("click",a),"visit"===e&&this.wrapper.addEventListener("click",(function(e){e.target.closest(".modal__content-wrapper")&&e.target!==t&&e.target!==s||a()}))}showDefaultVisit(){this.wrapper.classList.remove("modal--hide"),this.wrapper.innerHTML="";const e=document.createElement("div");e.classList.add("modal__content-wrapper","modal__content-wrapper--visit"),this.wrapper.append(e),e.innerHTML='\n            <span span class="modal-close">×</span>\n            <div class="modal__content modal__content--visit">\n                <h3 class="modal__content-title modal__content-title--visit">VISIT FORM</h3>\n                <div class="modal__content-img">\n                    <img class="modal__content-icon modal__content-icon--visit" src="./dist/assets/images/patient.png" alt="LOGO">              \n                </div>\n                <form class="form-visit">\n                    <label class="form-visit__label">Doctor\n                        <select class="form-visit__select" id="select-doctor" name="specialist">\n                            <option value="">Select specialist</option>\n                            <option value="cardiologist">Cardiologist</option>\n                            <option value="dentist">Dentist</option>\n                            <option value="therapist">Therapist</option>\n                        </select>\n                    </label>\n                    <label class="form-visit__label" id="form-patient-name">Patient name\n                        <input class="form-visit__input" type="text" id="patient-name" name="patient-name" placeholder="Enter full patient name">\n                    </label>\n                    <label class="form-visit__label" id="form-purpose">Purpose of the visit\n                        <input class="form-visit__input" type="text" id="purpose" name="purpose" placeholder="Enter purpose of the visit">\n                    </label>\n                    <label class="form-visit__label" id="form-description">Description of the visit\n                        <input class="form-visit__input" type="text" id="description" name="description" placeholder="Enter description of the visit">\n                    </label>\n                    <label class="form-visit__label" id="form-urgency">Urgency of the visit\n                        <div class="label-container-radio">\n                            <label class="form-visit__label--radio"> Normal\n                                <input type="radio" name="urgency" id="urgency-normal" value="normal" checked>\n                            </label>\n                            <label class="form-visit__label--radio"> Priority\n                                <input type="radio" name="urgency" id="urgency-priority" value="priority">\n                            </label>\n                            <label class="form-visit__label--radio"> Urgent\n                                <input type="radio" name="urgency" id="urgency-urgent" value="urgent">\n                            </label>\n                        </div>\n                    </label>\n                    <div class="form-visit__specialist"></div>\n                </form>\n            </div>',this.closeModal("visit");const t=this.wrapper.querySelectorAll('[name="urgency"]');this.wrapper.querySelector("#form-urgency").addEventListener("click",(e=>{t.forEach((t=>{t===e.target?t.setAttribute("checked",!0):t.removeAttribute("checked")}))}))}showSpecificFields(e){const t=this.wrapper.querySelector(".form-visit__specialist");console.log(t),"cardiologist"===e?t.innerHTML='\n               <label class="form-visit__label" id="form-pressure">Normal pressure\n                    <div class="form-pressure__container">\n                        <input class="form-visit__input form-visit__input--shot" type="number" id="pressure-top" name="pressure" placeholder="top">\n                        <span>⁄</span>\n                        <input class="form-visit__input form-visit__input--shot" type="number" id="pressure-bottom" name="pressure" placeholder="bottom">\n                    </div>\n                </label>\n                <label class="form-visit__label" id="form-body-mass">Body mass index\n                    <div class="form-body-mass__container">\n                    <output class="form-visit__label-output">25</output>\n                    <input oninput="this.previousElementSibling.value = this.value" class="form-visit__input" type="range" min="0" max="50" step="1" value="25" id="mass-index" name="mass-index" placeholder="Enter patient body mass index">\n                    </div>\n                </label>\n                <label class="form-visit__label" id="form-past-diseases">Past diseases of the cardiovascular system\n                    <textarea class="form-visit__text-area" placeholder="Enter pacient past diseases of the cardiovascular system"></textarea>\n                </label>\n                <label class="form-visit__label" id="form-age">Patient age\n                    <input class="form-visit__input form-visit__input--shot" type="number" id="age" name="age" placeholder="Age">\n                </label>\n                <button class="btn btn--big btn--bg-prime" type="submit">Create visit</button>':"dentist"===e?t.innerHTML='\n                <label class="form-visit__label" id="form-date">Date of last visit\n                    <input class="form-visit__input" type="date" id="visit" name="visit" placeholder="Enter date of last visit">\n                </label>\n                <button class="btn btn--big btn--bg-prime" type="submit">Create visit</button>':"therapist"===e&&(t.innerHTML='\n                <label class="form-visit__label" id="form-age">Patient age\n                    <input class="form-visit__input form-visit__input--shot" type="number" id="age" name="age" placeholder="Age">\n                </label>\n                <button class="btn btn--big btn--bg-prime" type="submit">Create visit</button>'),this.closeModal("visit")}createVisitParams(e){e.preventDefault();const t=this.wrapper.querySelector("#purpose"),s=this.wrapper.querySelector("#description"),i=this.wrapper.querySelector("#patient-name"),a=this.wrapper.querySelector('input[name="urgency"][checked="true"]')||"normal",n=this.wrapper.querySelector("#pressure-top")||"",r=this.wrapper.querySelector("#pressure-bottom")||"",o=this.wrapper.querySelector("#mass-index")||"",c=this.wrapper.querySelector(".form-visit__text-area")||"",d=this.wrapper.querySelector("#age")||"",l=this.wrapper.querySelector("#visit")||"";return{patient:i.value,purpose:t.value,description:s.value,urgency:a.value||"normal",...!!l.value&&{lastVisit:l.value},...!!n.value&&!!r.value&&{pressure:`${n.value}/${r.value}`},...!!o.value&&{BMI:o.value},...!!c.value&&{diseases:c.value},...!!d.value&&{age:d.value}}}addCurrentCardInfo({purpose:e,description:t,patient:s,urgency:i,pressure:a,BMI:n,diseases:r,age:o,lastVisit:c}){this.wrapper.querySelector("#select-doctor").parentNode.remove(),e&&(this.wrapper.querySelector("#purpose").value=e),t&&(this.wrapper.querySelector("#description").value=t),s&&(this.wrapper.querySelector("#patient-name").value=s),i&&this.wrapper.querySelector(`input[name="urgency"][value="${i}"]`).setAttribute("checked",!0),a&&(this.wrapper.querySelector("#pressure-top").value=a.slice(0,a.indexOf("/")),this.wrapper.querySelector("#pressure-bottom").value=a.slice(a.indexOf("/")+1)),n&&(this.wrapper.querySelector(".form-visit__label-output").value=n,this.wrapper.querySelector("#mass-index").value=n),r&&(this.wrapper.querySelector(".form-visit__text-area").value=r),o&&(this.wrapper.querySelector("#age").value=o),c&&(this.wrapper.querySelector("#visit").value=c)}showEditModal({doctor:e,...t}){this.showDefaultVisit(),this.showSpecificFields(e),this.addCurrentCardInfo(t)}}class i{constructor({id:e,doctor:t,purpose:s,description:i,urgency:a,patient:n,pressure:r,BMI:o,diseases:c,age:d,lastVisit:l,status:p}){this.id=e,this.doctor=t,this.purpose=s,this.description=i,this.urgency=a,this.patient=n,this.status=p||"",this.pressure=r||null,this.BMI=o||null,this.diseases=c||null,this.age=d||null,this.lastVisit=l||null}render(){const e=document.querySelector(".cards__content"),t=document.createElement("div");t.classList.add("card"),t.setAttribute("id",this.id),e.prepend(t),t.insertAdjacentHTML("afterbegin",`\n            <div class="card__container">\n                <span class="card-change">✎</span>\n                <span class="card-del">✖</span>\n                <div class="card__element card-title">\n                    <div class="card-title__doctor">\n                        <div class="card-title__doctor-head">DOCTOR:</div>\n                        <div class="card-title__doctor-text">\n                            <div class="card-title__doctor-text-icon">\n                                <picture>\n                                    <source srcset="./dist/assets/images/сard/therapist.webp" type="image/webp">\n                                    <img class="doctor-icon" src="./dist/assets/images/сard/therapist.png" alt="img">\n                                </picture>\n                            </div>\n                            <p class="card-title__doctor-text-value">${this.doctor}</p>\n                        </div>\n                    </div>\n                    <div class="card-title__status">\n                        <div class="card-title__status-head">VISIT STATUS:</div>\n                        <button class="card-title__status-text">${this.status.toUpperCase()}</button>\n                    </div>\n                </div>\n                <div class="card__element card-main">\n                    <div class="card-main__patient">\n                        <div class="card-main__patient-head">\n                            <p class="card-main__patient-head-title">PACIENT:</p>\n                            ${this.age?`<p class="card-main__patient-head-age">AGE:<span class="card-main__patient-head-age-val">${this.age}</span></p>`:""}\n                        </div>\n                        <div class="card-main__patient-text">${this.patient}</div>\n                    </div>\n                    <div class="card-main__urgency">\n                        <div class="card-main__urgency-head">URGENCY</div>\n                        <div class="card-main__urgency-body" data-urgency="${this.urgency}">\n                            <div class="urgency-body__elem urgency-body__elem--${this.urgency}"></div>\n                            <div class="urgency-body__elem urgency-body__elem--${this.urgency}"></div>\n                            <div class="urgency-body__elem urgency-body__elem--${this.urgency}"></div>\n                        </div>\n                    </div>\n                </div>\n                <div class="card-additional card-additional--hide">\n                    <div class="card-additional__purpose">\n                        <div class="card-additional__purpose-title">PURPOSE OF THE TARGET:</div>\n                        <div class="card-additional__purpose-text">${this.purpose}</div>\n                    </div>\n                    <div class="card-additional__description">\n                        <div class="card-additional__description-title">DESCRIPTION:</div>\n                        <div class="card-additional__description-text">${this.description}</div>\n                    </div>\n                    ${this.lastVisit?`\n                    <div class="card-additional__date">\n                        <div class="card-additional__date-title">DATE OF LAST VISIT:</div>\n                        <div class="card-additional__date-text">${this.lastVisit}</div>\n                    </div>`:""}\n                    ${this.BMI?`\n                    <div class="card-additional__imt">\n                        <div class="card-additional__imt-title">BMI:</div>\n                        <div class="card-additional__imt-text">${this.BMI} BMI</div>\n                    </div>`:""}\n                    ${this.pressure?`\n                    <div class="card-additional__pressure">\n                        <div class="card-additional__pressure-title">PRESSURE:</div>\n                        <div class="card-additional__pressure-text">${this.pressure} mmHg</div>\n                    </div>`:""}\n                    ${this.diseases?`\n                    <div class="card-additional__diseases">\n                        <div class="card-additional__diseases-title">DISEASES OF THE CARDIOVASCULAR:</div>\n                        <div class="card-additional__diseases-text">${this.diseases}</div>\n                    </div>`:""}\n                </div>\n                <div class="card-show-more">\n                    <button class="card-show-more__btn">SHOW MORE DETAILS</button>\n                    <picture>\n                        <source srcset="./dist/assets/images/icon-down.webp" type="image/webp">\n                        <img class="card-show-more__icon" src="./dist/assets/images/icon-down.png" alt="icon">\n                    </picture>\n                </div>\n                <div class="card-hide-more card-hide-more--hide">\n                    <button class="card-hide-more__btn">HIDE MORE DETAILS</button>\n                    <picture>\n                        <source srcset="./dist/assets/images/icon-up.webp" type="image/webp">\n                        <img class="card-hide-more__icon" src="./dist/assets/images/icon-up.png" alt="icon">\n                    </picture>\n                 </div>\n            </div>`);const s=t.querySelector(".card-del"),i=t.querySelector(".card-show-more__btn"),a=t.querySelector(".card-hide-more__btn"),n=t.querySelector(".card-additional"),r=t.querySelector(".card-change"),o=t.querySelector(".card-title__status-text");s.addEventListener("click",(()=>this.delete(t))),i.addEventListener("click",(()=>this.showDetails(i,a,n))),a.addEventListener("click",(()=>this.hideDetails(i,a,n))),r.addEventListener("click",(()=>this.openCardEditor())),o.addEventListener("click",(()=>this.changeStatus(o))),this.checkStatus(o)}async delete(t){200===(await(async e=>await fetch(`https://ajax.test-danit.com/api/v2/cards/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${JSON.parse(sessionStorage.token)}`}}))(t.id)).status&&t.remove(),e.delCardById(this.id),v()}showDetails(e,t,s){e.parentNode.classList.add("card-show-more--hide"),t.parentNode.classList.remove("card-hide-more--hide"),s.classList.remove("card-additional--hide")}hideDetails(e,t,s){e.parentNode.classList.remove("card-show-more--hide"),t.parentNode.classList.add("card-hide-more--hide"),s.classList.add("card-additional--hide")}openCardEditor(){!function(e){const t=document.querySelector(".modal"),i=new s(t),a=e;i.showEditModal(a);t.querySelector('button[type="submit"]').addEventListener("click",(t=>{const s=i.createVisitParams(t),n={...a,...s};e.saveChangesOnServer(n)}))}(this)}async changeStatus(e){const t=e=>this.saveChangesOnServer({...this,status:e});"OPEN"===e.textContent&&await t("done")?(e.innerHTML="DONE",e.closest(".card").classList.add("card-visit-done")):"DONE"===e.textContent&&await t("open")&&(e.innerHTML="OPEN",this.status="open")}checkStatus(e){"DONE"===e.textContent&&e.closest(".card").classList.add("card-visit-done")}async saveChangesOnServer(t){const s=await(async(e,t)=>200===(await fetch(`https://ajax.test-danit.com/api/v2/cards/${e}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${JSON.parse(sessionStorage.token)}`},body:JSON.stringify(t)})).status||(alert("Не удалось изменить карточку. Сервер не доступен"),!1))(t.id,t);return s&&(e.data=e.data.map((e=>e.id===t.id?t:e)),e.data.sort(((e,t)=>e.id-t.id)).sort(((e,t)=>e.status<t.status?-1:e.status<t.status?1:0)),document.querySelector(".cards__content").innerHTML="",m(e.data),w()),s}}class a{constructor({purpose:e,description:t,urgency:s,patient:i}){this.purpose=e,this.description=t,this.urgency=s,this.patient=i,this.status="open"}createJSON(e){return JSON.stringify({purpose:this.purpose,description:this.description,urgency:this.urgency,patient:this.patient,status:this.status,...e})}async sendVisitDataToServer(e){return(async e=>await fetch("https://ajax.test-danit.com/api/v2/cards",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${JSON.parse(sessionStorage.token)}`},body:e}))(this.createJSON(e))}}class n extends a{constructor({purpose:e,description:t,urgency:s,patient:i,pressure:a,BMI:n,diseases:r,age:o}){super({purpose:e,description:t,urgency:s,patient:i}),this.pressure=a,this.BMI=n,this.diseases=r,this.age=o}visit(){const e={doctor:"cardiologist",pressure:this.pressure,BMI:this.BMI,diseases:this.diseases,age:this.age};return this.sendVisitDataToServer(e)}}class r extends a{constructor({purpose:e,description:t,urgency:s,patient:i,lastVisit:a}){super({purpose:e,description:t,urgency:s,patient:i}),this.lastVisit=a}visit(){const e={doctor:"dentist",lastVisit:this.lastVisit};return this.sendVisitDataToServer(e)}}class o extends a{constructor({purpose:e,description:t,urgency:s,patient:i,age:a}){super({purpose:e,description:t,urgency:s,patient:i}),this.age=a}visit(){const e={doctor:"therapist",age:this.age};return this.sendVisitDataToServer(e)}}const[c,d]=document.querySelectorAll(".btn"),l=document.querySelector(".modal");function p(){d.classList.remove("btn--hide"),c.remove()}async function u(){const s=await t();e.data=[...s],e.data.sort(((e,t)=>e.id-t.id)).sort(((e,t)=>e.status<t.status?-1:e.status<t.status?1:0)),m(e.data),v()}function m(e){console.log(e),e.forEach((e=>{new i(e).render()}))}function v(){console.log("mainObject",e.data);const t=document.body.querySelector(".no-content");setTimeout((()=>{e.data.length&&sessionStorage.getItem("token")?t.classList.add("no-content--hide"):t.classList.remove("no-content--hide")}))}c.addEventListener("click",(()=>function(e){new s(e).showLoginForm();e.querySelector('button[type="submit"]').addEventListener("click",(t=>async function(e,t){e.preventDefault();const s=t.querySelector('input[name="username"]').value,i=t.querySelector('input[name="password"]').value,a=await(async(e,t)=>{const s=await fetch("https://ajax.test-danit.com/api/v2/cards/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});return 200===s.status&s.ok?s.text():void alert("Incorrect login or password")})(s,i);a&&(t.innerHTML="",t.classList.add("modal--hide"),sessionStorage.token=JSON.stringify(a),u(),p())}(t,e)))}(l))),d.addEventListener("click",(()=>function(t){const a=new s(t);a.showDefaultVisit();const c=t.querySelector("#select-doctor");c.addEventListener("input",(()=>{a.showSpecificFields(c.value),t.querySelector('button[type="submit"]').addEventListener("click",(t=>async function(t,s){let a;"cardiologist"===t&&(a=new n(s)),"dentist"===t&&(a=new r(s)),"therapist"===t&&(a=new o(s));const c=await a.visit();200===c.status?function(t){new i(t).render(),e.data.push(t),v()}(await c.json()):alert("Не удалось создать карточку. Сервер не доступен")}(c.value,a.createVisitParams(t))))}))}(l))),sessionStorage.getItem("token")&&p(),sessionStorage.getItem("token")?u():v();const h=document.body.querySelector(".search-form__input"),_=document.body.querySelector('select[name="search-status"]'),y=document.body.querySelector('select[name="search-priority"]'),g=document.body.querySelector('button[name="search-button"]'),b=document.body.querySelector('button[name="search-all"]'),f=document.body.querySelector(".cards__content");g.addEventListener("click",(()=>w()));const S=()=>({...!!h.value&&{text:h.value},...!!_.value&&{status:_.value},...!!y.value&&{urgency:y.value}});function w(){const t=S();if(Object.keys(t).length){const s=e.data.filter((e=>t.urgency?e.urgency===t.urgency:e)).filter((e=>t.text?[e.patient,e.description,e.purpose].some((e=>e.toLowerCase().includes(t.text.toLowerCase()))):e)).filter((e=>t.status?e.status===t.status:e));f.innerHTML="",L(s),m(s)}}function L(e){const t=document.body.querySelector(".no-search");e.length?t.classList.add("no-search--hide"):t.classList.remove("no-search--hide")}b.addEventListener("click",(()=>{[h,_,y].forEach((e=>e.value="")),f.innerHTML="",L(e.data),m(e.data)})),console.log("main js"),(e=>{const t=new Image;t.onload=t.onerror=()=>{(e=>{const t=!0===e?"webp":"no-webp";document.documentElement.classList.add(t)})(2==t.height)},t.src="data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA"})()})();